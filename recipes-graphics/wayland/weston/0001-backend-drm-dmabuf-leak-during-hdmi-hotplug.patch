From 2086a542965b2bbcf8d5569df4c290e3ac3f6532 Mon Sep 17 00:00:00 2001
From: Wujian Sun <wujian.sun_1@nxp.com>
Date: Tue, 17 Jan 2023 11:10:19 +0800
Subject: [PATCH] backend-drm: dmabuf leak during hdmi hotplug

Close dumb buffer dmafd when output destoryed.

Upstream-Status: Inappropriate [i.MX-specific]

Signed-off-by: Wujian Sun <wujian.sun_1@nxp.com>
---
 libweston/backend-drm/drm-gbm.c      | 7 ++++---
 libweston/backend-drm/drm-internal.h | 1 +
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/libweston/backend-drm/drm-gbm.c b/libweston/backend-drm/drm-gbm.c
index ea03fd7c..21d88efd 100644
--- a/libweston/backend-drm/drm-gbm.c
+++ b/libweston/backend-drm/drm-gbm.c
@@ -437,13 +437,13 @@ drm_output_init_g2d(struct drm_output *output, struct drm_backend *b)
 
 	for (i = 0; i < ARRAY_LENGTH(output->dumb); i++) {
 		struct g2d_surfaceEx* g2dSurface = &(output->g2d_image[i]);
-		int ret, dmafd = 0;
+		int ret;
 		output->dumb[i] = drm_fb_create_dumb(b, w, h, format);
 		if (!output->dumb[i])
 			goto err;
 
 		ret = drmPrimeHandleToFD(b->drm.fd, output->dumb[i]->handles[0], DRM_CLOEXEC,
-				       &dmafd);
+				       &output->dumb_dmafd[i]);
 		if(ret < 0)
 			goto err;
 
@@ -452,7 +452,7 @@ drm_output_init_g2d(struct drm_output *output, struct drm_backend *b)
 						w, h,
 						output->dumb[i]->strides[0],
 						output->dumb[i]->size,
-						dmafd);
+						output->dumb_dmafd[i]);
 		if (ret < 0)
 			goto err;
 	}
@@ -487,6 +487,7 @@ drm_output_fini_g2d(struct drm_output *output)
 	for (i = 0; i < ARRAY_LENGTH(output->dumb); i++) {
 		drm_fb_unref(output->dumb[i]);
 		output->dumb[i] = NULL;
+		close(output->dumb_dmafd[i]);
 	}
 	b->g2d_renderer->output_destroy(&output->base);
 }
diff --git a/libweston/backend-drm/drm-internal.h b/libweston/backend-drm/drm-internal.h
index a4b4a0d6..324f7166 100644
--- a/libweston/backend-drm/drm-internal.h
+++ b/libweston/backend-drm/drm-internal.h
@@ -591,6 +591,7 @@ struct drm_output {
 	pixman_image_t *image[3];
 #if defined(ENABLE_IMXGPU) && defined(ENABLE_IMXG2D)
 	struct g2d_surfaceEx g2d_image[3];
+	int dumb_dmafd[3];
 #endif
 	int current_image;
 	pixman_region32_t previous_damage;
